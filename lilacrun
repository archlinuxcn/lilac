#!/bin/bash -e

lockit () {
  exec {lockfd}<>~/.lilac/.lock
  flock -n $lockfd || {
    echo "Waiting for lock to release..."
    flock $lockfd
  }
}

download-pylib(){
  mkdir -p "$LILACPATH"/pylib
  cd "$LILACPATH"/pylib
  wget -q "https://raw.githubusercontent.com/lilydjwg/winterpy/master/pylib/"{archpkg,htmlutils,mailutils,myutils,nicelogger,serializer}.py
}

getconfig(){
  awk -F '=' "/\[$1\]/{i=1}i==1&&\$1~/$2/{print \$2;exit}" "$LILACPATH"/config.ini
}

lockit
mkdir -p ~/.lilac/log

set +e
. /etc/profile
set -e

export LILACPATH TZ LANG TERM PATH PYTHONPATH
LILACPATH="$(dirname "$(readlink -f "${0}")")"

TZ=$(getconfig 'enviroment variables' timezone)
LANG=$(getconfig 'enviroment variables' locale)
TERM=$(getconfig 'enviroment variables' terminal)
PATH=$LILACPATH:$PATH

[ ! -d "$LILACPATH"/pylib ] && download-pylib
PYTHONPATH=$LILACPATH/pylib:$PYTHONPATH

lilac "$@" > ~/.lilac/log/"$(date +'%Y-%m-%dT%H:%M:%S')" 2>&1
